# Windows Patches for Cursor Agent CLI

This document describes the patches applied to make Cursor Agent CLI work on Windows.

## Patch Summary

| Patch | Purpose | Trade-off |
|-------|---------|-----------|
| MerkleClient Stub | Bypass missing Windows native module | No repository indexing/semantic search |
| PTY Stub | Bypass Linux-only PTY module | No interactive shell mode |
| createRequire Fix | Fix Linux file URLs | None |
| Binary Replacements | Provide Windows executables | Uses Cursor IDE binaries |

---

## Patch 1: MerkleClient Stub

**Problem**: The `../merkle-tree/native.js` module tries to load a Windows native binary that doesn't exist in the Linux package.

**Location**: Search for `/***/"../merkle-tree/native.js":`

**Original Code** (abbreviated):
```javascript
/***/"../merkle-tree/native.js":
/***/(module,__unused_webpack_exports,__webpack_require__)=>{
// prettier-ignore
/* eslint-disable */
// @ts-nocheck
/* auto-generated by NAPI-RS (adapted for multi-platform) */
let nativeBinding=null;let loadError=null;const{platform:platform,arch:arch}=process;try{if(platform==="darwin"){...}else if(platform==="linux"){...}else if(platform==="win32"){if(arch==="x64"){nativeBinding=__webpack_require__(Object(function webpackMissingModule(){var e=new Error("Cannot find module './merkle-tree-napi.win32-x64-msvc.node'");e.code="MODULE_NOT_FOUND";throw e}()))}...
```

**Replacement**:
```javascript
/***/"../merkle-tree/native.js":
/***/(module,__unused_webpack_exports,__webpack_require__)=>{
/* WINDOWS PATCH: Stub MerkleClient - repository indexing disabled on Windows */
class MerkleClient{constructor(paths){this._paths=paths}async build(){return null}async getTreeStructure(){return null}async getSimhash(){return new Uint8Array(64)}async getNumEmbeddableFiles(){return 0}}
module.exports={MerkleClient:MerkleClient,MULTI_ROOT_ABSOLUTE_PATH:""};
/***/},
```

---

## Patch 2: PTY Stub

**Problem**: The code tries to load `pty.node` which is a Linux ELF binary.

**Location**: Search for `process.dlopen(module,__webpack_require__("path").join(__dirname,__webpack_require__.p,"pty.node"))`

**Original Code**:
```javascript
try{process.dlopen(module,__webpack_require__("path").join(__dirname,__webpack_require__.p,"pty.node"))}catch(error){throw new Error("node-loader:\n"+error)}
```

**Replacement**:
```javascript
try{/* WINDOWS PATCH: PTY stubbed - shell mode disabled */module.exports={fork:function(){throw new Error("PTY not available on Windows")},spawn:function(){throw new Error("PTY not available on Windows")},native:{}};}catch(error){console.error("PTY stub loaded - shell mode disabled")}
```

---

## Patch 3: createRequire File URL Fix

**Problem**: The code uses a hardcoded Linux file URL for `createRequire()`.

**Location**: Search for `createRequire("file:///__w/everysphere`

**Original Code**:
```javascript
const pty_manager_require=(0,external_node_module_namespaceObject.createRequire)("file:///__w/everysphere/everysphere/packages/exec-daemon/dist/pty-manager.js")
```

**Replacement**:
```javascript
const pty_manager_require=(0,external_node_module_namespaceObject.createRequire)(__filename)
```

---

## Binary Replacements

The following binaries need to be copied from a Cursor IDE Windows installation:

### ripgrep (rg.exe)
**Source**: `C:\Program Files\cursor\resources\app\node_modules\@vscode\ripgrep\bin\rg.exe`

**Destination**: Copy as both `rg.exe` and `rg` (the code looks for `rg` without extension)

### SQLite3 (node_sqlite3.node)
**Source**: `C:\Program Files\cursor\resources\app\node_modules\@vscode\sqlite3\build\Release\vscode-sqlite3.node`

**Destination**: `node_sqlite3.node`

### PTY (pty.node)
**Source**: `C:\Program Files\cursor\resources\app\node_modules\node-pty\build\Release\pty.node`

**Destination**: `pty.node` (Note: This binary exists but the code is stubbed, so it's not actually used)

---

## PowerShell Patching Script

```powershell
# Apply patches to a fresh Linux cursor-agent package
param(
    [string]$SourceDir = ".",
    [string]$CursorIdePath = "C:\Program Files\cursor"
)

$indexPath = Join-Path $SourceDir "index.js"
$content = Get-Content $indexPath -Raw

# Patch 1: Stub MerkleClient
$oldMerkle = '/***/"../merkle-tree/native.js":
/***/(module,__unused_webpack_exports,__webpack_require__)=>{
// prettier-ignore
/* eslint-disable */
// @ts-nocheck
/* auto-generated by NAPI-RS (adapted for multi-platform) */
let nativeBinding=null;let loadError=null;const{platform:platform,arch:arch}=process;try{if(platform==="darwin")'

# ... (matching the full original module content)

$newMerkle = '/***/"../merkle-tree/native.js":
/***/(module,__unused_webpack_exports,__webpack_require__)=>{
/* WINDOWS PATCH: Stub MerkleClient - repository indexing disabled on Windows */
class MerkleClient{constructor(paths){this._paths=paths}async build(){return null}async getTreeStructure(){return null}async getSimhash(){return new Uint8Array(64)}async getNumEmbeddableFiles(){return 0}}
module.exports={MerkleClient:MerkleClient,MULTI_ROOT_ABSOLUTE_PATH:""};
/***/},'

# Apply Patch 1
# (Implementation depends on exact content matching)

# Patch 2: Stub PTY
$oldPty = 'try{process.dlopen(module,__webpack_require__("path").join(__dirname,__webpack_require__.p,"pty.node"))}catch(error){throw new Error("node-loader:\n"+error)}'
$newPty = 'try{/* WINDOWS PATCH: PTY stubbed */module.exports={fork:function(){throw new Error("PTY not available on Windows")},spawn:function(){throw new Error("PTY not available on Windows")},native:{}};}catch(error){}'
$content = $content.Replace($oldPty, $newPty)

# Patch 3: Fix createRequire
$oldCreateRequire = 'const pty_manager_require=(0,external_node_module_namespaceObject.createRequire)("file:///__w/everysphere/everysphere/packages/exec-daemon/dist/pty-manager.js")'
$newCreateRequire = 'const pty_manager_require=(0,external_node_module_namespaceObject.createRequire)(__filename)'
$content = $content.Replace($oldCreateRequire, $newCreateRequire)

Set-Content $indexPath $content -NoNewline

# Copy Windows binaries
Copy-Item "$CursorIdePath\resources\app\node_modules\@vscode\ripgrep\bin\rg.exe" -Destination "$SourceDir\rg.exe"
Copy-Item "$SourceDir\rg.exe" -Destination "$SourceDir\rg"
Copy-Item "$CursorIdePath\resources\app\node_modules\@vscode\sqlite3\build\Release\vscode-sqlite3.node" -Destination "$SourceDir\node_sqlite3.node"
Copy-Item "$CursorIdePath\resources\app\node_modules\node-pty\build\Release\pty.node" -Destination "$SourceDir\pty.node"

Write-Host "Patches applied successfully!"
```

---

## Verification

After patching, verify the installation:

```cmd
node --use-system-ca index.js --version
node --use-system-ca index.js --help
echo "Hello" | node --use-system-ca index.js --print --output-format text agent -
```

The version command should print the version, help should show available commands, and the echo command should require authentication (which confirms the agent is working).
